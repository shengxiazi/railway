<!--_meta 作为公共模版分离出去-->
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <LINK rel="Bookmark" href="/favicon.ico" >
    <LINK rel="Shortcut Icon" href="/favicon.ico" />

    <link rel="stylesheet" type="text/css" href="../static/h-ui/css/H-ui.min.css" />
    <link rel="stylesheet" type="text/css" href="../static/h-ui.admin/css/H-ui.admin.css" />
    <link rel="stylesheet" type="text/css" href="../lib/Hui-iconfont/1.0.7/iconfont.css" />
    <link rel="stylesheet" type="text/css" href="../static/h-ui.admin/skin/default/skin.css" id="skin" />
    <link rel="stylesheet" type="text/css" href="../lib/easyui/easyui.css">
    <link rel="stylesheet" type="text/css" href="../static/h-ui.admin/css/ks-style.css" />
    <!--[if IE 6]>
    <script>DD_belatedPNG.fix('*');</script>
    <![endif]-->
    <!--/meta 作为公共模版分离出去-->
    <title>灌砂法测定填料压实密度试验记录</title>
    <style>
        #fivthtable th{
            text-align:center;
        }
        #fivthtable td{
            text-align:center;
        }
    </style>
</head>
<body>
<div class="easyui-layout" data-options="fit:true">
    <form class="form form-horizontal" id="ysAdd">
        <div data-options="region:'center',split:true" style="width:100%">
            <div class="page-container">
                <div class="row cl">
                    <div class="col-sm-7">
                        <table class="table " id="firstable" style="border:1px solid #9c9c9c">
                            <tr class="text-c">
                                <td colspan="4" class="border-line">
                                    <h4>委托信息及测点详情</h4>
                                </td>
                            </tr>
                            <tr class="text-l">
                                <th colspan="3"><span class="c-red">*</span>检测编号</th>
                                <th><span class="c-red">*</span>检测方式</th>
                            </tr>
                            <tr class="text-c">
                                <td colspan="3"><input type="text" class="input-text text-c" name="SerialNo" id="SerialNo"/></td>
                                <td>
                                    <select name="TestWay" id="TestWay" style="width:100%;height:100%">
                                        <option value="1">初测</option>
                                        <option value="2">复测</option>
                                        <option value="3">加测</option>
                                    </select>
                                </td>

                            </tr>
                            <tr class="text-l">
                                <th>测点里程标识</th>
                                <th colspan="2"><span class="c-red">*</span>测点里程（m）</th>
                                <th ><span class="c-red">*</span>测点方位</th>
                            </tr>
                            <tr>
                                <td>
                                    <input type="text" class="input-text text-r"  name="mileageFlag" disabled/>
                                </td>
                                <td colspan="2">
                                    <input type="text" class="input-text text-c" name="PointMileageNum"/>
                                </td>
                                <td>
                                    <input type="text" class="input-text text-c" name="Direction"/>
                                </td>
                            </tr>
                            <tr class="text-l">
                                <th><span class="c-red">*</span>记录编号</th>
                                <th>采用标准</th>
                                <th><span class="c-red">*</span>标准砂密度ρ<sub>sr</sub>(g/cm<sup>3</sup>)</th>
                                <th><span class="c-red">*</span>试验日期</th>
                            </tr>
                            <tr>
                                <td><input type="text" class="input-text text-c" name="TestCode"/></td>
                                <td><input type="text" class="input-text text-c" name="TestStandard" value="TB10102-2010"/></td>
                                <td>
                                    <input type="text" class="input-text text-c" name="Psr"/>
                                </td>
                                <td><input onfocus="WdatePicker({dateFmt:'yyyy-MM-dd'})" type="text"  class="input-text text-c Wdate" name="StartTime" id="StartTime"/></td>
                            </tr>
                            <tr class="text-c">
                                <th>颗粒密度ρ sm(g/cm3)</th>
                                <th colspan="2">最大干密度ρ dmax(g/cm3)</th>
                                <th>最优含水率 ω dmax(%)</th>
                            </tr>
                            <tr>
                                <td><input type="text" class="input-text text-c" name="particleDensity" disabled/></td>
                                <td colspan="2"><input type="text" class="input-text text-c" name="dryDensity" disabled/></td>
                                <td><input type="text" class="input-text text-c" name="waterContent" disabled/></td>
                            </tr>
                            <tr class="text-c">
                                <td colspan="4" class="border-line"><h4>仪器设备及环境条件</h4></td>
                            </tr>
                            <tr class="text-l">
                                <th><span class="c-red">*</span>灌砂筒</th>
                                <th>电子秤</th>
                                <th><span class="c-red">*</span>温度℃</th>
                                <th><span class="c-red">*</span>相对湿度（%）</th>
                            </tr>
                            <tr>
                                <td><input type="text" class="input-text text-c" name="MachineId"/></td>
                                <td><input type="text" class="input-text text-c" name="Diameter" value="300"/></td>
                                <td><input type="text" class="input-text text-c" name="Temperature"/></td>
                                <td><input type="text" class="input-text text-c" name="Humidity"/></td>
                            </tr>
                        </table>
                        <table class="table " id="secondtable" style="margin-top:10px; border:1px solid #9c9c9c;border-bottom:0; background-color:rgba(238,238,238,0.98)" >
                            <tr class="text-r">
                                <th  style="padding-top:20px">工程名称：</th>
                                <td  style="padding-top:20px" colspan="5">
                                    <input type="text" class="input-none text-l"  name="ProjectName" value="" disabled/>
                                </td>
                            </tr>
                            <tr class="text-r" >
                                <th >委托单位：</th>
                                <td colspan="3"><input type="text" class="input-none text-l"  name="sgXmComName" value="" disabled/></td>
                                <th><span class="c-red">*</span>检测标高(m)：</th>
                                <td><input type="text" class="input-none text-l" name="testHeight" id="testHeight" disabled/></td>
                            </tr>

                            <tr class="text-r">
                                <th>施工里程：</th>
                                <td colspan="3"><input type="text" class="input-none text-l" name="mileage" disabled value=""/></td>
                                <input type="hidden" class="input-none text-l" name="mileage" disabled/>
                                <th>压实方式：</th>
                                <td><input type="text" class="input-none text-l" name="compactionMode" disabled/></td>
                            </tr>
                            <tr class="text-r">
                                <th><span class="c-red">*</span>检测部位：</th>
                                <td>

                                    <input type="text" class="input-none text-l" name="position" disabled/>
                                </td>
                                <th><span class="c-red">*</span>当前层数：</th>
                                <td><input type="text" class="input-none text-l" name="layer" disabled/></td>
                                <th><span class="c-red">*</span>总层数：</th>
                                <td>
                                    <input type="text" class="input-none text-l" name="totalLayer" disabled/>
                                </td>
                            </tr>
                            <tr class="text-r">
                                <th style="padding-bottom:15px;width:80px">填料名称：</th>
                                <td style="padding-bottom:15px;width:150px"><input type="text" class="input-none text-l" name="fillingStyle" disabled/></td>
                                <th style="width:140px; padding-bottom:15px"><span class="c-red">*</span>填料最大粒径(mm)：</th>
                                <td style="padding-bottom:15px;width:40px;">
                                    <input type="text" class="input-none text-l" name="fillingDiameter" disabled/>
                                </td>
                                <th style="padding-bottom:15px;width:120px;"><span class="c-red">*</span>填层厚度(cm):</th>
                                <td  style="padding-bottom:15px; width:80px">
                                    <input type="text" class="input-none text-l" name="fillingThickness" disabled/>
                                </td>
                            </tr>
                        </table>
                        <table class="table table-border table-bordered" id="Mtable" style=" background-color:rgba(238,238,238,0.98)">
                            <tr class="text-c">
                                <th>仪器设备名称</th>
                                <th>型号</th>
                                <th>示值范围</th>
                                <th>分辨力</th>
                            </tr>
                            <tr>
                                <td><input type="text" class="input-none" name="equipTypeName" disabled/></td>
                                <td><input type="text" class="input-none" name="equipSpec" disabled/></td>
                                <td><input type="text" class="input-none" name="equipRange" disabled/></td>
                                <td><input type="text" class="input-none" name="equipResolution" disabled/></td>
                            </tr>
                            <tr>
                                <td><input type="text" class="input-none" name="equipTypeName" disabled/></td>
                                <td><input type="text" class="input-none" name="equipSpec" disabled/></td>
                                <td><input type="text" class="input-none" name="equipRange" disabled/></td>
                                <td><input type="text" class="input-none" name="equipResolution" disabled/></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-sm-5">
                        <table class="table table-border table-bordered" id="fivthtable" style=" background-color:rgba(238,238,238,0.98);">
                            <tr>
                                <th colspan="3">灌砂法数据录入栏</th>
                            </tr>
                            <tr class="text-c">
                                <th width="50px">项目</th>
                                <th width="250px">记录内容</th>
                                <th>记录值</th>
                            </tr>
                            <tr>
                                <th>(1)</th>
                                <th><span class="c-red">*</span>密度测定器灌满标准砂总质量m<sub>r3</sub>(g)</th>
                                <td><input type="text" class="input-none text-c" name="Mr3" /></td>
                            </tr>
                            <tr>
                                <th>(2)</th>
                                <th> <span class="c-red">*</span>灌满灌砂漏斗所需标准砂质量m<sub>r4</sub>(g)</th>
                                <td><input type="text" class="input-none text-c" name="Mr4" /></td>
                            </tr>
                            <tr>
                                <th>(3)</th>
                                <th><span class="c-red">*</span>密度测定器和剩余标准砂总质量m<sub>r5</sub>(g)</th>
                                <td><input type="text" class="input-none text-c" name="Mr5" /></td>
                            </tr>
                            <tr>
                                <th>(4)</th>
                                <th>灌满试坑所用标准砂质量m<sub>sr</sub>(g)</th>
                                <td><input type="text" class="input-none text-c" name="Msr" disabled/></td>
                            </tr>
                            <tr>
                                <th>(5)</th>
                                <th>试坑体积V<sub>p</sub>(cm<sub>3</sub>)</th>
                                <td><input type="text" class="input-none text-c" name="Vp"  disabled/></td>
                            </tr>
                            <tr>
                                <th>(6)</th>
                                <th><span class="c-red">*</span>土和容器总质量(g)</th>
                                <td><input type="text" class="input-none text-c" name="Mpr" /></td>
                            </tr>
                            <tr>
                                <th>(7)</th>
                                <th><span class="c-red">*</span>容器质量(g)</th>
                                <td><input type="text" class="input-none text-c" name="Mr" /></td>
                            </tr>
                            <tr>
                                <th>(8)</th>
                                <th>试坑土的质量m<sub>p</sub>(g)</th>
                                <td><input type="text" class="input-none text-c" name="Mp"  disabled/></td>
                            </tr>
                            <tr>
                                <th>(9)</th>
                                <th>土的湿密度ρ<sub>0</sub>(g/cm<sup>3</sup>)</th>
                                <td><input type="text" class="input-none text-c" name="P0" disabled /></td>
                            </tr>
                            <tr>
                                <th>(10)</th>
                                <th><span class="c-red">*</span>土的含水率ω(%)</th>
                                <td><input type="text" class="input-none text-c" name="W"/></td>
                            </tr>
                            <tr>
                                <th>(11)</th>
                                <th>土的干密度ρ<sub>0</sub>(g/cm<sup>3</sup>)</th>
                                <td><input type="text" class="input-none text-c" name="Pd" disabled/></td>
                            </tr>
                            <tr>
                                <th><button class="btn btn-success radius size-MINI calculate" type="button"><i class="Hui-iconfont">&#xe632;</i>计算</button></th>
                                <th>压实系数K</th>
                                <td><input type="text" class="input-none text-c" name="KysReal" disabled /></td>
                            </tr>
                            <tr>
                                <th>(12)</th>
                                <th>压实系数K规定值</th>
                                <td><input type="text" class="input-none text-c" name="design" id="design" disabled /></td>
                            </tr>
                            <tr>
                                <th></th>
                                <th>检测结论</th>
                                <td>
                                    <select class="select" name="Result" id="Result" style="height:100%">
                                        <option value="0">未判定</option>
                                        <option value="1" selected>合格</option>
                                        <option value="2">不合格</option>
                                    </select>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div data-options="region:'south'" style="height:40px; padding-top:5px; text-align:center ;background-color:#F8F8F8;border-top:solid #eee 1px" >
            <button class="btn btn-primary radius  size-S" onclick="save_submit()" type="button" data-toggle="tooltip" title="点我之前，请确保先计算数据了哟！">
                <i class="Hui-iconfont">&#xe632;</i>保存退出</button>
            <button onClick="layer_close();" class="btn btn-default radius" type="button">&nbsp;&nbsp;取消&nbsp;&nbsp;</button>
        </div>
    </form>
</div>

<script type="text/javascript" src="../lib/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="../lib/layer/2.1/layer.js"></script>
<script type="text/javascript" src="../lib/easyui/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/jquery.validate.min.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/validate-methods.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/messages_zh.min.js"></script>
<script type="text/javascript" src="../lib/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="../static/h-ui/js/H-ui.js"></script>
<script type="text/javascript" src="../static/h-ui.admin/js/H-ui.admin.js"></script>
<script>
    var projectId = sessionStorage.pro_id;
    var id = sessionStorage.BasicInfoId;
    var data = new Object();
    var submited =false;
    $(function(){
        $("[data-toggle='tooltip']").tooltip();
        //显示数据
        $.ajax({
            url: "/api/v1/YSData/"+projectId+'/'+id,    //请求的url地址
            dataType: "json",
            async:false,
            type: "GET",
            success: function (reg) {
                if (reg.code == 0) {
                    $.each(reg.data,function(n,v){
                        $('input[name="'+n+'"]').val(v);
                        if(n=='SerialNo'){
                            var serNum =v.substr(0,15);
                            $('#SerialNo').val(serNum);
                            planData($.trim(serNum));
                        }
                        if(n=='KysDesign'){
                            $('#design').val(v);
                        }
                        if(n=='Result'){
                            $('#Result').val(v);
                        }
                        if(n=='StartTime'){
                            $('input[name="'+n+'"]').val(v.substr(0,10));
                        }
                    });
                } else {
                    layer.msg(reg.message, {icon: 6, time: 2000});
                }
            }
        });
        //根据委托编号取值
        $('#planCode').bind('change',function(){
            var planCode = $.trim(this.value);
            $('#planCode').val(planCode);
                planData(planCode);
        });

        //计算
        $('#fivthtable').on('click','.calculate',function(){
            if(validform().form()) {
                get_data();
            }
        });

    });

    //根据委托编号获取值
    function planData(planCode){
        $.ajax({
            url:'/api/v1/TPlan/'+planCode+'/BySerialNo',
            dataType :"json",
            async:false,
            type: "GET",
            success:function(reg){
                var planData = reg.data;
                if(reg.code==0){
                    $.each(planData,function(n,value){
                        $('input[name="'+n+'"]').val(value);
                    });
                    $.each(planData.testQuota,function(n,v){
                        if(v.testQuotaCode=='K'){
                            $('input[name="KysDesign"]').val(v.design);
                        }
                    });
                    $('input[name="ProjectName"]').val(sessionStorage.projectName);
                }else{
                    layer.msg(reg.message,{icon:6,time:2000});
                }
            },
            error:function(){
                layer.msg('服务器异常！');
            }
        });
    }

    //表单验证
    function validform(){
        return  $("#ysAdd").validate({
            debug:true,
            rules:{
                planCode:{
                    required:true
                },
                recordNum:{
                    required:true
                },
                PointMileageNum:{
                    required:true
                },
                Direction:{
                    required:true
                },
                Temperature:{
                    required:true,
                    digits:true

                },
                Humidity:{
                    required:true,
                    digits:true
                },
                Psr:{
                    required:true,
                    number:true
                },
                Pdmax:{
                    required:true,
                    number:true
                },
                Mr3:{
                    required:true
                },
                Mr4:{
                    required:true
                },
                Mr5:{
                    required:true
                },
                Mpr:{
                    required:true
                },
                Mr:{
                    required:true
                },
                W:{
                    required:true
                }
            }
        });
    }

    //获取计算数据
    function get_data(){
        var Mr3 = $('input[name="Mr3"]').val();
        var Mr4 = $('input[name="Mr4"]').val();
        var Mr5 = $('input[name="Mr5"]').val();
        var Mpr = $('input[name="Mpr"]').val();
        var Mr = $('input[name="Mr"]').val();
        //土的含水率
        var W = $('input[name="W"]').val();

        //最大干密度
        var Pdmax = $('input[name="dryDensity"]').val();

        var Msr = parseFloat(Mr3) - parseFloat(Mr4) - parseFloat(Mr5);
        //试坑土的质量
        var Mp = parseFloat(Mpr) - parseFloat(Mr);
        //获取标准砂密度
        var ρ = $('input[name="Psr"]').val();
        //试坑体积
        var Vp = Msr / parseFloat(ρ);
        //土的湿密度
        var P0 = Mp / Vp;
        //土的干密度
        var Pd = P0 / (1 + 0.01 * parseFloat(W));
        //ys实测值
        var KysReal = Pd / parseFloat(Pdmax);
        var ysdesign= parseFloat($('#design').val());

        if(KysReal>=ysdesign){
            $('#Result').val(1);
            data['Result'] = 1;
        } else if(KysReal<ysdesign){
            $('#Result').val(2);
            data['Result'] = 2;
        }else{
            $('#Result').val(0);
            data['Result'] = 0;
        }

        $('input[name="Msr"]').val(Msr);
        $('input[name="Mp"]').val(Mp);
        $('input[name="Vp"]').val(Math.ceil(Vp));
        $('input[name="P0"]').val(P0.toFixed(2));
        $('input[name="Pd"]').val(Pd.toFixed(2));
        $('input[name="KysReal"]').val(KysReal.toFixed(3));

        data['Msr'] = Msr;
        data['Mp'] = Mp;
        data['Vp'] = Math.ceil(Vp);
        data['P0'] = P0.toFixed(2);
        data['Pd'] = Pd.toFixed(2);
        data['KysReal'] =KysReal.toFixed(3);
    }
    //表单提交
    function save_submit(){
        if (validform().form()) {
            get_data();
            data['SerialNo'] = $('#SerialNo').val();
            data['TestCode'] = $('input[name="TestCode"]').val();
            data['TestWay'] = 1;
            data['PointMileageFlag'] = $('input[name="mileageFlag"]').val();
            data['KysDesign'] = parseFloat($('input[name="design"]').val());

            data['GpsIsValid'] = 0;
            data['GpsLatitude'] = 0.01;
            data['GpsLongitude'] = 0.02;
            data['StartTime'] = $('input[name="StartTime"]').val();
            data['Temperature'] = $('input[name="Temperature"]').val();
            data['TestStandard'] =$('input[name="TestStandard"]').val();
            data['Humidity'] = $('input[name="Humidity"]').val();

            data['Pdmax'] = $('input[name="dryDensity"]').val();
            data['Psr'] = $('input[name="Psr"]').val();
            data['MachineId'] = $('input[name="MachineId"]').val();
            data['Mr3'] = parseFloat($('input[name="Mr3"]').val());
            data['W'] = parseFloat($('input[name="W"]').val());
            data['Mr4'] = parseFloat($('input[name="Mr4"]').val());
            data['Mr5'] = parseFloat($('input[name="Mr5"]').val());
            data['Mpr'] = parseFloat($('input[name="Mpr"]').val());
            data['Mr'] = parseFloat($('input[name="Mr"]').val());
            data['PointMileageNum'] = parseFloat($('input[name="PointMileageNum"]').val());
            data['Direction'] = $('input[name="Direction"]').val();

            $.ajax({
                url: "/api/v1/YSData/" + projectId+"/"+id,    //请求的url地址
                dataType: "json",
                async: true,
                data: data,
                type: "PUT",
                success: function (reg) {
                    submited =false;
                    if (reg.code == 0) {
                        layer.msg(reg.message, {icon: 1, time: 2000},function(){
                            parent.location.href ='/ys/testdata.html';
                        });
                    } else {
                        layer.msg(reg.message, {icon: 6, time: 2000});
                    }
                },
                error: function () {
                    submited =false;
                    layer.msg('服务器异常！', {icon: 6, time: 2000})
                }
            });

        }

    }
</script>
</body>
</html>