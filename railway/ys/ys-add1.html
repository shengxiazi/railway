<!--_meta 作为公共模版分离出去-->
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <LINK rel="Bookmark" href="/favicon.ico" >
    <LINK rel="Shortcut Icon" href="/favicon.ico" />

    <link rel="stylesheet" type="text/css" href="../static/h-ui/css/H-ui.min.css" />
    <link rel="stylesheet" type="text/css" href="../static/h-ui.admin/css/H-ui.admin.css" />
    <link rel="stylesheet" type="text/css" href="../lib/Hui-iconfont/1.0.7/iconfont.css" />
    <link rel="stylesheet" type="text/css" href="../static/h-ui.admin/skin/default/skin.css" id="skin" />
    <link rel="stylesheet" type="text/css" href="../static/h-ui.admin/css/style.css" />
    <link rel="stylesheet" type="text/css" href="../static/h-ui.admin/css/table.css" />
    <!--[if IE 6]>
    <script>DD_belatedPNG.fix('*');</script>
    <![endif]-->
    <!--/meta 作为公共模版分离出去-->
    <title>灌砂法测定填料压实密度试验记录</title>
    <style>
        #oneTable th{width:75px; text-align:right;}
        #oneTable td{position:relative}
    </style>
</head>
<body>
<div class="container">
    <form class="form form-horizontal" id="ysAdd">
         <div class="col-sm-12" style="background-color:#fff">
        <div class="row cl">
            <div class="col-sm-12">
                <table id="oneTable">
                    <tr class="text-c">
                        <th colspan="6" style="border-bottom:0; font-weight:bold"><h4 id="xmName">灌砂法测定填料压实密度试验记录</h4></th>
                    </tr>
                    <tr>
                        <th>委托单位：</th>
                        <td><div class="content"><input type="text" class="input-none" name="company" disabled/></div></td>
                        <th>工程名称：</th>
                        <td><div class="content"><input type="text" class="input-none" name="proName" disabled/></div></td>
                        <th>施工里程：</th>
                        <td><div class="content">
                            <input type="text" class="input-none" name="mileage" disabled/>
                            <input type="hidden" class="input-none" name="mileageFlag"/>
                        </div>
                        </td>
                    </tr>
                    <tr>
                        <th><span class="c-red">*</span>委托编号：</th>
                        <td><div class="content"><input type="text" class="input-none" id="planCode" name="planCode"/></div></td>
                        <th><span class="c-red">*</span>记录编号：</th>
                        <td><div class="content"><input type="text" class="input-none" name="recordNum"/></div></td>
                        <th>填料名称：</th>
                        <td><div class="content"><input type="text" class="input-none" name="fillingStyle" disabled/></div></td>
                    </tr>
                    <tr>
                        <th>压实方式：</th>
                        <td><div class="content"><input type="text" class="input-none" name="compactionMode" disabled/></div></td>
                        <th style="width:95px">设计压实系数：</th>
                        <td><div class="content"><input type="text" class="input-none" name="design" disabled/></div></td>
                        <th><span class="c-red">*</span>试验日期：</th>
                        <td><div class="content">
                            <input  style="width:80%"  onfocus="WdatePicker({dateFmt:'yyyy-MM-dd'})" type="text" class="input-none Wdate" name="StartTime" placeholder="">
                        </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="row cl mt-10">
            <div class="col-sm-12">
                <table id="secondTable" class="table table-border table-bordered table-striped">
                    <tr class="text-c">
                        <th rowspan="6">仪器设备<br>及设备环境条件</th>
                        <th>仪器设备名称</th>
                        <th>型号</th>
                        <th>管理编号</th>
                        <th>市值范围</th>
                        <th>分辨力</th>
                        <th><span class="c-red">*</span>温度℃</th>
                        <th><span class="c-red">*</span>相对湿度（%）</th>
                    </tr>
                    <tr class="text-c">
                        <td><input type="text" class="input-none" name="equipTypeName"/></td>
                        <td><input type="text" class="input-none" name="equipSpec"/></td>
                        <td><input type="text" class="input-none" name="equipNo"/></td>
                        <td><input type="text" class="input-none" name="equipRange"/></td>
                        <td><input type="text" class="input-none" name="equipResolution"/></td>
                        <td rowspan="5"><input type="text" class="input-none" name="Temperature"/></td>
                        <td rowspan="5"><input type="text" class="input-none" name="Humidity"/></td>
                    </tr>
                    <tr class="text-c">
                        <td><input type="text" class="input-none" name="equipTypeName"/></td>
                        <td><input type="text" class="input-none" name="equipSpec"/></td>
                        <td><input type="text" class="input-none" name="equipNo"/></td>
                        <td><input type="text" class="input-none" name="equipRange"/></td>
                        <td><input type="text" class="input-none" name="equipResolution"/></td>
                    </tr>
                    <tr class="text-c">
                        <td><input type="text" class="input-none" name="equipTypeName"/></td>
                        <td><input type="text" class="input-none" name="equipSpec"/></td>
                        <td><input type="text" class="input-none" name="equipNo"/></td>
                        <td><input type="text" class="input-none" name="equipRange"/></td>
                        <td><input type="text" class="input-none" name="equipResolution"/></td>
                    </tr>
                    <tr class="text-c">
                        <td><input type="text" class="input-none" name="equipTypeName"/></td>
                        <td><input type="text" class="input-none" name="equipSpec"/></td>
                        <td><input type="text" class="input-none" name="equipNo"/></td>
                        <td><input type="text" class="input-none" name="equipRange"/></td>
                        <td><input type="text" class="input-none" name="equipResolution"/></td>
                    </tr>
                    <tr class="text-c">
                        <td><input type="text" class="input-none" name="equipTypeName"/></td>
                        <td><input type="text" class="input-none" name="equipSpec"/></td>
                        <td><input type="text" class="input-none" name="equipNo"/></td>
                        <td><input type="text" class="input-none" name="equipRange"/></td>
                        <td><input type="text" class="input-none" name="equipResolution"/></td>
                    </tr>
                    <tr class="text-c">
                        <th>填料压实<br>状态描述</th>
                        <td><input type="text" class="input-none" name="compactionDescription"/></td>
                        <th><span class="c-red">*</span>标准砂密度<br>ρ<sub>sr</sub>(g/cm<sup>3</sup>)</th>
                        <td><input type="text" class="input-none" name="Psr"/></td>
                        <th>采用标准</th>
                        <td colspan="3"><input type="text" class="input-none"/></td>
                    </tr>
                    <tr class="text-c">
                        <th><span class="c-red">*</span>最大干密度ρ<br><sub>dmax</sub>(g/cm<sup>3</sup>)</th>
                        <th>最优含水率ω<sub>opt</sub>(%)</th>
                        <th>颗粒密度<br>ρ<sub>sm</sub>(g/cm<sup>3</sup>)</th>
                        <th>施工日期</th>
                        <th>填土层次</th>
                        <th>压实遍数</th>
                        <th>填层标高(m)</th>
                        <th>填层压实厚度(cm)</th>
                    </tr>
                    <tr>
                        <td><input type="text" class="input-none" name="dryDensity" disabled/></td>
                        <td><input type="text" class="input-none" name="waterContent" disabled/></td>
                        <td><input type="text" class="input-none" name="particleDensity" disabled/></td>
                        <td><input type="text" class="input-none" name="constructionDate" disabled/></td>
                        <td><input type="text" class="input-none" name="totalLayer" disabled/></td>
                        <td><input type="text" class="input-none" name="compactionNum" disabled/></td>
                        <td><input type="text" class="input-none" name="testHeight" disabled/></td>
                        <td><input type="text" class="input-none" name="fillingThickness" disabled/></td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="row cl" style="margin-top:0">
            <div class="col-sm-12">
                <table class="table table-border table-bordered table-striped"  id="thirdTable" style="border-top:0">
                    <tr class="text-c">
                        <th rowspan="2">测点编号</th>
                        <th colspan="2">测点位置</th>
                        <th rowspan="2">
                            <span class="c-red">*</span>密度测定器<br>灌满标准砂<br>总质量<br>m<sub>r3</sub>(g)</th>
                        <th rowspan="2">
                            <span class="c-red">*</span>灌满灌砂漏<br>斗所需标准<br>砂质量<br>m<sub>r4</sub>(g)</th>
                        <th rowspan="2">
                            <span class="c-red">*</span>密度测定器<br>和剩余标准<br>砂总质量<br>m<sub>r5</sub>(g)</th>
                        <th rowspan="2">灌满试坑<br>所用标准<br>砂质量<br>m<sub>sr</sub>(g)</th>
                        <th rowspan="2">试坑<br>体积<br>V<sub>p</sub>(cm<sub>3</sub>)</th>
                        <th rowspan="2"><span class="c-red">*</span>土和容器总质量(g)</th>
                        <th rowspan="2"><span class="c-red">*</span>容器质量(g)</th>
                        <th rowspan="2">试坑土的质量<br>m<sub>p</sub>(g)</th>
                        <th rowspan="2">土的<br>湿密度<br>ρ<sub>0</sub>(g/cm<sup>3</sup>)</th>
                        <th rowspan="2"><span class="c-red">*</span>土的含水率ω(%)</th>
                        <th rowspan="2">土的干密度<br>ρ<sub>d</sub>(g/cm<sup>3</sup>)</th>
                        <th rowspan="2">压实系数K</th>
                        <th rowspan="2">操作</th>
                    </tr>
                    <tr class="text-c">
                        <th><span class="c-red">*</span>测点里程(m)</th>
                        <th><span class="c-red">*</span>方位</th>
                    </tr>
                    <tr>
                        <td><input type="text" class="input-none" name="num1" value="1" disabled/></td>
                        <td><input type="text" class="input-none" name="PointMileageNum1" /></td>
                        <td><input type="text" class="input-none" name="Direction1" /></td>
                        <td><input type="text" class="input-none" name="Mr31"/></td>
                        <td><input type="text" class="input-none" name="Mr41"/></td>
                        <td><input type="text" class="input-none" name="Mr51"/></td>
                        <td><input type="text" class="input-none" name="Msr1" disabled/></td>
                        <td><input type="text" class="input-none" name="Vp1" disabled/></td>
                        <td><input type="text" class="input-none" name="Mpr1"/></td>
                        <td><input type="text" class="input-none" name="Mr1"/></td>
                        <td><input type="text" class="input-none" name="Mp1" disabled/></td>
                        <td><input type="text" class="input-none" name="P01" disabled/></td>
                        <td><input type="text" class="input-none" name="W1"/></td>
                        <td><input type="text" class="input-none" name="Pd1" disabled/></td>
                        <td><input type="text" class="input-none" name="KysReal1" disabled/></td>
                        <td><button class="btn btn-success radius size-MINI calculate" type="button"><i class="Hui-iconfont">&#xe632;</i>计算</button></td>
                    </tr>
                    <tr id="ysdata">
                        <td colspan="16">附注：</td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="row cl mt-5">
            <div class="col-sm-12">
                <span >试验人员：</span>
                <div class="content" style="display:inline;width:60%">
                    <select  size="1"  id="testId" name="testId">

                    </select>
                </div>
            </div>
        </div>
        <div class="row cl mt-30 mb-20">
            <div class="col-xs-8 col-sm-6 col-xs-offset-4 col-sm-offset-5">
                <button class="btn btn-primary radius" onclick="save_submit()" type="button"><i class="Hui-iconfont">&#xe632;</i> 保存</button>
                <button onClick="layer_close();" class="btn btn-default radius" type="button">&nbsp;&nbsp;取消&nbsp;&nbsp;</button>
            </div>
        </div>
    </div>
    </form>
</div>
<script type="text/javascript" src="../lib/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="../lib/layer/2.1/layer.js"></script>
<script type="text/javascript" src="../lib/icheck/jquery.icheck.min.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/jquery.validate.min.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/validate-methods.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/messages_zh.min.js"></script>
<script type="text/javascript" src="../lib/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="../static/h-ui/js/H-ui.js"></script>
<script type="text/javascript" src="../static/h-ui.admin/js/H-ui.admin.js"></script>
<script>
    var projectId = sessionStorage.pro_id;
     var submited =false;

    $(function(){
        //根据委托编号取值
        $('#planCode').bind('change',function(){
            var planCode = $.trim(this.value);
            $('#planCode').val(planCode);
            $.ajax({
                url:'/api/v1/TPlan/'+projectId+'/'+planCode+'/ByPlanCode',
                dataType :"json",
                async:false,
                type: "GET",
                success:function(reg){
                    var planData = reg.data;
                    if(reg.code==0){
                        $.each(planData,function(n,value){
                           $('input[name="'+n+'"]').val(value);
                        });
                            $.each(planData.testQuota,function(n,v){
                                if(v.testQuotaCode=='K'){
                                    $('input[name="design"]').val(v.design);
                                }
                            });

                        $('input[name="proName"]').val(sessionStorage.projectName);
                    }else{
                        layer.msg(reg.message,{icon: 6, time: 2000});
                    }
                },
                error:function(){
                    layer.msg('委托编号不存在！');
                }
            });
        });

        $('#thirdTable').on('click','.calculate',function(){
            if(validform().form()) {
                var index = $(this).parents('tr').index() - 1;
                var Mr3 = $('input[name="Mr3' + index + '"]').val();
                var Mr4 = $('input[name="Mr4' + index + '"]').val();
                var Mr5 = $('input[name="Mr5' + index + '"]').val();
                var Mpr = $('input[name="Mpr' + index + '"]').val();
                var Mr = $('input[name="Mr' + index + '"]').val();
                //土的含水率
                var W = $('input[name="W' + index + '"]').val();
                //最大干密度
                var Pdmax = $('input[name="dryDensity"]').val();

                if(Mr3==null || Mr3==''|| Mr3==undefined){
                    layer.msg('Mr3值不能为空！',{icon:6,time:3000});
                    return false;
                }
                if(Mr4==null || Mr4==''|| Mr4==undefined){
                    layer.msg('Mr3值不能为空！',{icon:6,time:3000});
                    return false;
                }
                if(Mr5==null || Mr5==''|| Mr5==undefined){
                    layer.msg('Mr3值不能为空！',{icon:6,time:3000});
                    return false;
                }
                if(Mpr==null || Mpr==''|| Mpr==undefined){
                    layer.msg('土和容器总质量值不能为空',{icon:6,time:3000});
                    return false;
                }
                if(Mr==null || Mr==''|| Mr==undefined){
                    layer.msg('容器质量值不能为空',{icon:6,time:3000});
                    return false;
                }
                if(W==null || W==''|| W==undefined){
                    layer.msg('土的含水率值不能为空！',{icon:6,time:3000});
                    return false;
                }


                var Msr = parseFloat(Mr3) - parseFloat(Mr4) - parseFloat(Mr5);
                //试坑土的质量
                var Mp = parseFloat(Mpr) - parseFloat(Mr);
                //获取标准砂密度
                var ρ = $('input[name="Psr"]').val();
                //试坑体积
                var Vp = Msr / parseFloat(ρ);
                //土的湿密度
                var P0 = Mp / Vp;
                //土的干密度
                var Pd = P0 / (1 + 0.01 * parseFloat(W));

                //ys实测值
                var KysReal = Pd / parseFloat(Pdmax);
                $('input[name="Msr' + index + '"]').val(Msr);
                $('input[name="Mp' + index + '"]').val(Mp);
                $('input[name="Vp' + index + '"]').val(Vp);
                $('input[name="P0' + index + '"]').val(P0.toFixed(2));
                $('input[name="Pd' + index + '"]').val(Pd.toFixed(2));
                $('input[name="KysReal' + index + '"]').val(KysReal.toFixed(2));
                //获取当前表格的填数据的总行数
                var rowNum = $('#thirdTable tr').length - 3;
                var rowIndex = index + 1;
                if (rowNum >= rowIndex) {
                    return false;
                }
                var str = '<tr>';
                str += '<td><input type="text" class="input-none" name="num' + rowIndex + '" value="' + rowIndex + '" disabled/></td>';
                str += '<td><input type="text" class="input-none" name="PointMileageNum' + rowIndex + '"/></td>';
                str += '<td><input type="text" class="input-none" name="Direction' + rowIndex + '"/></td>';
                str += '<td><input type="text" class="input-none" name="Mr3' + rowIndex + '"/></td>';
                str += '<td><input type="text" class="input-none" name="Mr4' + rowIndex + '"/></td>';
                str += '<td><input type="text" class="input-none" name="Mr5' + rowIndex + '"/></td>';
                str += '<td><input type="text" class="input-none" name="Msr' + rowIndex + '" disabled/></td>';
                str += '<td><input type="text" class="input-none" name="Vp' + rowIndex + '" disabled/></td>';
                str += '<td><input type="text" class="input-none" name="Mpr' + rowIndex + '"/></td>';
                str += '<td><input type="text" class="input-none" name="Mr' + rowIndex + '"/></td>';
                str += '<td><input type="text" class="input-none" name="Mp' + rowIndex + '" disabled/></td>';
                str += '<td><input type="text" class="input-none" name="P0' + rowIndex + '" disabled/></td>';
                str += '<td><input type="text" class="input-none" name="W' + rowIndex + '"/></td>';
                str += '<td><input type="text" class="input-none" name="Pd' + rowIndex + '" disabled/></td>';
                str += '<td><input type="text" class="input-none" name="KysReal' + rowIndex + '" disabled/></td>';
                str += '<td><button class="btn btn-success radius size-MINI calculate" type="button"><i class="Hui-iconfont">&#xe632;</i>计算</button></td>';
                str += '</tr>';
                $('#ysdata').before(str);
            }
        });

        //获取实验人员列表
        $.ajax({
            url:'/api/v1/XMPerson/'+projectId+'/LiteListByProjId',
            dataType:"json",
            async:false,
            type:'GET',
            success:function(reg){
                if(reg.code==0){
                    var testStr = "<option value=''>--请选择--</option>";
                    $.each(reg.data,function(k,v){
                        testStr+='<option value="'+ v.value+'">'+ v.name+'</option>';
                    });
                    $('#testId').append(testStr);
                }
            }
        });
    });

    //表单验证
    function validform(){
        return  $("#ysAdd").validate({
            debug:true,
            rules:{
                planCode:{
                    required:true
                },
                recordNum:{
                    required:true
                },
                PointMileageNum:{
                    required:true
                },
                Direction:{
                    required:true
                },
                Temperature:{
                    required:true,
                    digits:true

                },
                Humidity:{
                    required:true,
                    digits:true
                },
                Psr:{
                    required:true,
                    digits:true
                },
                Pdmax:{
                    required:true,
                    digits:true
                },
                testId:{
                    required:true
                }
            }
        });
    }
    //表单提交
    function save_submit(){
        if( checkSubmit()) {
            if (validform().form()) {
                var rowNum = $('#thirdTable tr').length - 3;
                var data = new Object();
                data['PlanCode'] = $('#planCode').val();
                data['TestCode'] = $('input[name="recordNum"]').val();
                data['TestWay'] = 1;
                data['PointMileageFlag'] = $('input[name="mileageFlag"]').val();
                data['KysDesign'] = parseFloat($('input[name="design"]').val());

                data['GpsIsValid'] = 0;
                data['GpsLatitude'] = 0.01;
                data['GpsLongitude'] = 0.02;
                data['StartTime'] = $('input[name="StartTime"]').val();
                data['Temperature'] = $('input[name="Temperature"]').val();
                data['Humidity'] = $('input[name="Humidity"]').val();
                data['TestId'] = $('#testId').val();
                data['Pdmax'] = $('input[name="dryDensity"]').val();
                data['Psr'] = $('input[name="Psr"]').val();

                for (var i = 1; i < rowNum; i++) {
                    data['Mr3'] = parseFloat($('input[name="Mr3' + i + '"]').val());
                    data['W'] = parseFloat($('input[name="W' + i + '"]').val());
                    data['Mr4'] = parseFloat($('input[name="Mr4' + i + '"]').val());
                    data['Mr5'] = parseFloat($('input[name="Mr5' + i + '"]').val());
                    data['Mpr'] = parseFloat($('input[name="Mpr' + i + '"]').val());
                    data['Mr'] = parseFloat($('input[name="Mr' + i + '"]').val());
                    data['Msr'] = parseFloat($('input[name="Msr' + i + '"]').val());
                    data['Mp'] = parseFloat($('input[name="Mp' + i + '"]').val());
                    data['Vp'] = parseFloat($('input[name="Vp' + i + '"]').val());
                    data['P0'] = parseFloat($('input[name="P0' + i + '"]').val());
                    data['Pd'] = parseFloat($('input[name="Pd' + i + '"]').val());
                    data['PointMileageNum'] = parseFloat($('input[name="PointMileageNum' + i + '"]').val());
                    data['Direction'] = $('input[name="Direction' + i + '"]').val();
                    data['KysReal'] = parseFloat($('input[name="KysReal' + i + '"]').val());
                    if (data['KysReal'] >= data['KysDesign']) {
                        data['Result'] = 1;
                    } else if (data['KysReal'] < data['KysDesign']) {
                        data['Result'] = 2;
                    } else {
                        data['Result'] = 0;
                    }

                    $.ajax({
                        url: "/api/v1/YSData/" + projectId,    //请求的url地址
                        dataType: "json",
                        async: true,
                        data: data,
                        type: "POST",
                        success: function (reg) {
                            if (reg.code == 0) {
                                layer.msg(reg.message, {icon: 1, time: 2000});
                                submited =false;
                            } else {
                                layer.msg(reg.message, {icon: 6, time: 2000});
                            }
                        },
                        error: function () {
                            layer.msg('服务器异常！', {icon: 6, time: 2000})
                        }
                    });

                }
            }
        }
    }
</script>
</body>
</html>